-- สร้างตาราง TB_DATA_WO
CREATE TABLE TB_DATA_WO (
  AGREEMENT_NO VARCHAR(15),
  OUTSTANDING_BALANCE DECIMAL(10, 2),
  AGE_OF_WRITE_OFF INT,
  AUTO_TYPE_NAME VARCHAR(20),
  COLLECTOR_CODE VARCHAR(10),
  REPO_STATUS VARCHAR(1)
);

-- เพิ่มข้อมูลในตาราง TB_DATA_WO
INSERT INTO TB_DATA_WO (AGREEMENT_NO, OUTSTANDING_BALANCE, AGE_OF_WRITE_OFF, AUTO_TYPE_NAME, COLLECTOR_CODE, REPO_STATUS)
VALUES
  ('061000020000929', 25000, 2, 'Motorcycle', 'OA1010', '-'),
  ('061000020003800', 50000, 3, 'Motorcycle', 'OA1011', 'W'),
  ('061000020005149', 165000, 2, 'Non Motorcycle', 'OA1011', 'W'),
  ('061000020006709', 200000, 1, 'Non Motorcycle', 'OA1012', '-'),
  ('061000020007110', 355000, 1, 'Non Motorcycle', 'OA1012', 'W');

-- สร้างตาราง TB_DATA_JUDETYPE
CREATE TABLE TB_DATA_JUDETYPE (
  AGREEMENT_NO VARCHAR(15),
  JUDGE_TYPE INT
);

-- เพิ่มข้อมูลในตาราง TB_DATA_JUDETYPE
INSERT INTO TB_DATA_JUDETYPE (AGREEMENT_NO, JUDGE_TYPE)
VALUES
  ('061000020000929', 1),
  ('061000020004200', 2),
  ('061000020005149', 0),
  ('061000020003099', 1),
  ('061000020007110', 2);

-- สร้างตาราง TB_CAR_CASE
CREATE TABLE TB_CAR_CASE (
  AGREEMENT_NO VARCHAR(15),
  CAR_CASE_DESC VARCHAR(50)
);

-- เพิ่มข้อมูลในตาราง TB_CAR_CASE
INSERT INTO TB_CAR_CASE (AGREEMENT_NO, CAR_CASE_DESC)
VALUES
  ('061000020002909', 'รถที่เป็นซาก'),
  ('061000020001180', 'รถเคลมประกัน'),
  ('061000020001459', 'รถเคลมประกัน'),
  ('061000020006709', 'รถติดคดี'),
  ('061000020007220', 'รถเคลมประกัน');

-- แบ่งกลุ่มข้อมูล
SELECT
  tb1.AGREEMENT_NO,
  tb1.OUTSTANDING_BALANCE,
  tb2.JUDGE_TYPE,
  CASE
    WHEN tb1.OUTSTANDING_BALANCE < 50000 THEN 'Group 1'
    WHEN tb1.OUTSTANDING_BALANCE >= 50000 AND tb2.JUDGE_TYPE NOT IN (1, 2) THEN 'Group 2'
    WHEN tb1.OUTSTANDING_BALANCE >= 50000 AND tb2.JUDGE_TYPE IN (1, 2) THEN 'Group 3'
  END AS Group,
  tb1.AGE_OF_WRITE_OFF,
  tb1.AUTO_TYPE_NAME
FROM
  TB_DATA_WO tb1
LEFT JOIN
  TB_DATA_JUDETYPE tb2 ON tb1.AGREEMENT_NO = tb2.AGREEMENT_NO
LEFT JOIN
  TB_CAR_CASE tb3 ON tb1.AGREEMENT_NO = tb3.AGREEMENT_NO
WHERE
  (tb1.OUTSTANDING_BALANCE < 50000 OR
  (tb1.OUTSTANDING_BALANCE >= 50000 AND tb2.JUDGE_TYPE NOT IN (1, 2)) OR
  (tb1.OUTSTANDING_BALANCE >= 50000 AND tb2.JUDGE_TYPE IN (1, 2)))
  AND (tb3.CAR_CASE_DESC IS NULL OR tb3.CAR_CASE_DESC NOT LIKE '%รถเคลมประกัน%' OR tb3.CAR_CASE_DESC NOT LIKE '%รถติดคดี%' OR tb3.CAR_CASE_DESC NOT LIKE '%รถที่เป็นซาก%');


-- สร้างตาราง TB_DATA_WO
CREATE TABLE TB_DATA_WO (
  AGREEMENT_NO VARCHAR(15),
  OUTSTANDING_BALANCE DECIMAL(10, 2),
  AGE_OF_WRITE_OFF INT,
  AUTO_TYPE_NAME VARCHAR(20),
  COLLECTOR_CODE VARCHAR(10),
  REPO_STATUS VARCHAR(1)
);

-- เพิ่มข้อมูลในตาราง TB_DATA_WO
INSERT INTO TB_DATA_WO (AGREEMENT_NO, OUTSTANDING_BALANCE, AGE_OF_WRITE_OFF, AUTO_TYPE_NAME, COLLECTOR_CODE, REPO_STATUS)
VALUES
  ('061000020000929', 25000, 2, 'Motorcycle', 'OA1010', '-'),
  ('061000020003800', 50000, 3, 'Motorcycle', 'OA1011', 'W'),
  ('061000020005149', 165000, 2, 'Non Motorcycle', 'OA1011', 'W'),
  ('061000020006709', 200000, 1, 'Non Motorcycle', 'OA1012', '-'),
  ('061000020007110', 355000, 1, 'Non Motorcycle', 'OA1012', 'W');

-- สร้างตาราง TB_DATA_JUDETYPE
CREATE TABLE TB_DATA_JUDETYPE (
  AGREEMENT_NO VARCHAR(15),
  JUDGE_TYPE INT
);

-- เพิ่มข้อมูลในตาราง TB_DATA_JUDETYPE
INSERT INTO TB_DATA_JUDETYPE (AGREEMENT_NO, JUDGE_TYPE)
VALUES
  ('061000020000929', 1),
  ('061000020004200', 2),
  ('061000020005149', 0),
  ('061000020003099', 1),
  ('061000020007110', 2);

-- สร้างตาราง TB_CAR_CASE
CREATE TABLE TB_CAR_CASE (
  AGREEMENT_NO VARCHAR(15),
  CAR_CASE_DESC VARCHAR(50)
);

-- เพิ่มข้อมูลในตาราง TB_CAR_CASE
INSERT INTO TB_CAR_CASE (AGREEMENT_NO, CAR_CASE_DESC)
VALUES
  ('061000020002909', 'รถที่เป็นซาก'),
  ('061000020001180', 'รถเคลมประกัน'),
  ('061000020001459', 'รถเคลมประกัน'),
  ('061000020006709', 'รถติดคดี'),
  ('061000020007220', 'รถเคลมประกัน');

-- แบ่งกลุ่มข้อมูล
WITH incentives AS (
  SELECT
    tb1.AGREEMENT_NO,
    tb1.OUTSTANDING_BALANCE,
    tb2.JUDGE_TYPE,
    CASE
      WHEN tb1.OUTSTANDING_BALANCE < 50000 THEN 'Group 1'
      WHEN tb1.OUTSTANDING_BALANCE >= 50000 AND tb2.JUDGE_TYPE NOT IN (1, 2) THEN 'Group 2'
      WHEN tb1.OUTSTANDING_BALANCE >= 50000 AND tb2.JUDGE_TYPE IN (1, 2) THEN 'Group 3'
    END AS Group,
    tb1.AGE_OF_WRITE_OFF,
    tb1.AUTO_TYPE_NAME,
    CASE
      WHEN tb1.REPO_STATUS = 'W' THEN
        CASE
          WHEN tb1.AUTO_TYPE_NAME = 'Motorcycle' THEN
            CASE
              WHEN tb1.AGE_OF_WRITE_OFF <= 1 AND tb1.OUTSTANDING_BALANCE < 10000 THEN 1500
              WHEN tb1.AGE_OF_WRITE_OFF <= 1 AND tb1.OUTSTANDING_BALANCE >= 10000 AND tb1.OUTSTANDING_BALANCE < 30000 THEN 2000
              WHEN tb1.AGE_OF_WRITE_OFF <= 1 AND tb1.OUTSTANDING_BALANCE >= 30000 THEN 2500
              WHEN tb1.AGE_OF_WRITE_OFF > 1 AND tb1.AGE_OF_WRITE_OFF <= 3 AND tb1.OUTSTANDING_BALANCE < 10000 THEN 2000
              WHEN tb1.AGE_OF_WRITE_OFF > 1 AND tb1.AGE_OF_WRITE_OFF <= 3 AND tb1.OUTSTANDING_BALANCE >= 10000 AND tb1.OUTSTANDING_BALANCE < 30000 THEN 2500
              WHEN tb1.AGE_OF_WRITE_OFF > 1 AND tb1.AGE_OF_WRITE_OFF <= 3 AND tb1.OUTSTANDING_BALANCE >= 30000 THEN 3000
              ELSE 0
            END
          WHEN tb1.AUTO_TYPE_NAME = 'Non Motorcycle' THEN
            CASE
              WHEN tb1.AGE_OF_WRITE_OFF <= 1 AND tb1.OUTSTANDING_BALANCE < 100000 THEN 2500
              WHEN tb1.AGE_OF_WRITE_OFF <= 1 AND tb1.OUTSTANDING_BALANCE >= 100000 AND tb1.OUTSTANDING_BALANCE < 300000 THEN 3100
              WHEN tb1.AGE_OF_WRITE_OFF <= 1 AND tb1.OUTSTANDING_BALANCE >= 300000 THEN 3600
              WHEN tb1.AGE_OF_WRITE_OFF > 1 AND tb1.AGE_OF_WRITE_OFF <= 3 AND tb1.OUTSTANDING_BALANCE < 100000 THEN 3000
              WHEN tb1.AGE_OF_WRITE_OFF > 1 AND tb1.AGE_OF_WRITE_OFF <= 3 AND tb1.OUTSTANDING_BALANCE >= 100000 AND tb1.OUTSTANDING_BALANCE < 300000 THEN 3600
              WHEN tb1.AGE_OF_WRITE_OFF > 1 AND tb1.AGE_OF_WRITE_OFF <= 3 AND tb1.OUTSTANDING_BALANCE >= 300000 THEN 4100
              ELSE 0
            END
          ELSE 0
        END
      ELSE 0
    END AS Incentive
  FROM
    TB_DATA_WO tb1
  LEFT JOIN
    TB_DATA_JUDETYPE tb2 ON tb1.AGREEMENT_NO = tb2.AGREEMENT_NO
  LEFT JOIN
    TB_CAR_CASE tb3 ON tb1.AGREEMENT_NO = tb3.AGREEMENT_NO
  WHERE
    (tb1.OUTSTANDING_BALANCE < 50000 OR
    (tb1.OUTSTANDING_BALANCE >= 50000 AND tb2.JUDGE_TYPE NOT IN (1, 2)) OR
    (tb1.OUTSTANDING_BALANCE >= 50000 AND tb2.JUDGE_TYPE IN (1, 2)))
    AND (tb3.CAR_CASE_DESC IS NULL OR tb3.CAR_CASE_DESC NOT LIKE '%รถเคลมประกัน%' OR tb3.CAR_CASE_DESC NOT LIKE '%รถติดคดี%' OR tb3.CAR_CASE_DESC NOT LIKE '%รถที่เป็นซาก%')
)
SELECT
  AGREEMENT_NO,
  OUTSTANDING_BALANCE,
  JUDGE_TYPE,
  Group,
  AGE_OF_WRITE_OFF,
  AUTO_TYPE_NAME,
  Incentive
FROM
  incentives;


WITH incentives AS (
  SELECT
    tb1.AGREEMENT_NO,
    tb1.OUTSTANDING_BALANCE,
    tb2.JUDGE_TYPE,
    CASE
      WHEN tb1.OUTSTANDING_BALANCE < 50000 THEN 'Group 1'
      WHEN tb1.OUTSTANDING_BALANCE >= 50000 AND tb2.JUDGE_TYPE NOT IN (1, 2) THEN 'Group 2'
      WHEN tb1.OUTSTANDING_BALANCE >= 50000 AND tb2.JUDGE_TYPE IN (1, 2) THEN 'Group 3'
    END AS Group,
    tb1.AGE_OF_WRITE_OFF,
    tb1.AUTO_TYPE_NAME,
    CASE
      WHEN tb1.REPO_STATUS = 'W' THEN
        CASE
          WHEN tb1.AUTO_TYPE_NAME = 'Motorcycle' THEN
            CASE
              WHEN tb1.AGE_OF_WRITE_OFF <= 1 AND tb1.OUTSTANDING_BALANCE < 10000 THEN 1500
              WHEN tb1.AGE_OF_WRITE_OFF <= 1 AND tb1.OUTSTANDING_BALANCE >= 10000 AND tb1.OUTSTANDING_BALANCE < 30000 THEN 2000
              WHEN tb1.AGE_OF_WRITE_OFF <= 1 AND tb1.OUTSTANDING_BALANCE >= 30000 THEN 2500
              WHEN tb1.AGE_OF_WRITE_OFF > 1 AND tb1.AGE_OF_WRITE_OFF <= 3 AND tb1.OUTSTANDING_BALANCE < 10000 THEN 2000
              WHEN tb1.AGE_OF_WRITE_OFF > 1 AND tb1.AGE_OF_WRITE_OFF <= 3 AND tb1.OUTSTANDING_BALANCE >= 10000 AND tb1.OUTSTANDING_BALANCE < 30000 THEN 2500
              WHEN tb1.AGE_OF_WRITE_OFF > 1 AND tb1.AGE_OF_WRITE_OFF <= 3 AND tb1.OUTSTANDING_BALANCE >= 30000 THEN 3000
              ELSE 0
            END
          WHEN tb1.AUTO_TYPE_NAME = 'Non Motorcycle' THEN
            CASE
              WHEN tb1.AGE_OF_WRITE_OFF <= 1 AND tb1.OUTSTANDING_BALANCE < 100000 THEN 2500
              WHEN tb1.AGE_OF_WRITE_OFF <= 1 AND tb1.OUTSTANDING_BALANCE >= 100000 AND tb1.OUTSTANDING_BALANCE < 300000 THEN 3100
              WHEN tb1.AGE_OF_WRITE_OFF <= 1 AND tb1.OUTSTANDING_BALANCE >= 300000 THEN 3600
              WHEN tb1.AGE_OF_WRITE_OFF > 1 AND tb1.AGE_OF_WRITE_OFF <= 3 AND tb1.OUTSTANDING_BALANCE < 100000 THEN 3000
              WHEN tb1.AGE_OF_WRITE_OFF > 1 AND tb1.AGE_OF_WRITE_OFF <= 3 AND tb1.OUTSTANDING_BALANCE >= 100000 AND tb1.OUTSTANDING_BALANCE < 300000 THEN 3600
              WHEN tb1.AGE_OF_WRITE_OFF > 1 AND tb1.AGE_OF_WRITE_OFF <= 3 AND tb1.OUTSTANDING_BALANCE >= 300000 THEN 4100
              ELSE 0
            END
          ELSE 0
        END
      ELSE 0
    END AS Incentive
  FROM
    TB_DATA_WO tb1
  LEFT JOIN
    TB_DATA_JUDETYPE tb2 ON tb1.AGREEMENT_NO = tb2.AGREEMENT_NO
  LEFT JOIN
    TB_CAR_CASE tb3 ON tb1.AGREEMENT_NO = tb3.AGREEMENT_NO
  WHERE
    (tb1.OUTSTANDING_BALANCE < 50000 OR
    (tb1.OUTSTANDING_BALANCE >= 50000 AND tb2.JUDGE_TYPE NOT IN (1, 2)) OR
    (tb1.OUTSTANDING_BALANCE >= 50000 AND tb2.JUDGE_TYPE IN (1, 2)))
    AND (tb3.CAR_CASE_DESC IS NULL OR tb3.CAR_CASE_DESC NOT LIKE '%รถเคลมประกัน%' OR tb3.CAR_CASE_DESC NOT LIKE '%รถติดคดี%' OR tb3.CAR_CASE_DESC NOT LIKE '%รถที่เป็นซาก%')
)
SELECT
  Group,
  Collector_Code,
  Incentive
FROM
  (
    SELECT
      Group,
      Collector_Code,
      Incentive,
      ROW_NUMBER() OVER (PARTITION BY Group ORDER BY Incentive DESC) AS rn
    FROM
      incentives
  ) AS ranked
WHERE
  rn = 1;
